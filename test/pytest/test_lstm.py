import os.path as osp
import numpy as np
from toolchain import jit_file
from stdout_parser import extract_scalar, extract_1d, extract_2d, extract_3d

MLIR_FILES = osp.join(osp.dirname(__file__), "..", "Standalone")

def test_lstm_model():
    expected = np.array([0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00,
        0.0000e+00, 3.3778e-05, 0.0000e+00, 5.2637e-04, 0.0000e+00, 0.0000e+00,
        6.5392e-04, 1.5997e-04, 6.2927e-03, 3.0779e-03, 1.4083e-04, 2.8734e-04,
        1.0434e-03, 9.6927e-05, 7.4314e-04, 2.0633e-03, 1.1130e-03, 1.6138e-03,
        4.8937e-03, 4.1654e-03, 2.6135e-03, 2.9650e-04, 0.0000e+00, 0.0000e+00,
        0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00, 9.4826e-04,
        0.0000e+00, 1.7508e-03, 0.0000e+00, 0.0000e+00, 4.6779e-03, 8.5939e-04,
        1.8522e-02, 1.5481e-02, 3.2884e-03, 1.9617e-03, 1.2424e-03, 6.0613e-04,
        9.7039e-04, 3.8665e-03, 3.1308e-03, 1.9310e-02, 7.4453e-03, 3.9413e-03,
        2.2359e-03, 4.4542e-04, 3.3103e-03, 1.2262e-02, 8.3202e-03, 3.1042e-03,
        2.5563e-03, 5.4899e-03, 3.2366e-04, 2.0851e-04, 1.8899e-03, 2.1742e-03,
        7.2332e-03, 1.6029e-03, 1.2263e-03, 5.5024e-04, 6.7170e-03, 6.3360e-03,
        1.0013e-03, 1.7606e-03, 2.9170e-03, 3.2764e-03, 9.3320e-04, 2.4452e-03,
        3.3604e-03, 2.8265e-03, 7.0258e-03, 6.3038e-03, 2.7379e-03, 6.9153e-04,
        2.1527e-02, 1.7287e-02, 1.0392e-02, 5.8649e-03, 7.1520e-03, 1.8998e-02,
        4.7011e-03, 5.8537e-03, 6.8758e-03, 7.2315e-03, 2.3570e-02, 1.1471e-02,
        8.7724e-03, 2.9561e-03, 1.9771e-02, 3.1869e-02, 2.3380e-02, 1.2020e-02,
        3.4734e-03, 2.0489e-02, 1.2186e-03, 4.5820e-03, 9.4527e-03, 3.3821e-02,
        1.0689e-02, 5.9646e-03, 2.3423e-03, 1.0389e-03, 1.4429e-02, 2.2888e-02,
        6.2359e-03, 1.7254e-02, 2.1392e-02, 1.3973e-02, 9.3028e-03, 6.8425e-03,
        6.0731e-03, 5.9064e-03, 7.8745e-03, 2.2209e-03, 1.9926e-02, 1.3293e-02,
        6.9224e-03, 1.4848e-02, 1.0408e-02, 1.5290e-02, 1.1465e-02, 5.5877e-03,
        1.5420e-02, 1.6753e-03, 4.5590e-02, 4.3164e-02, 3.8253e-02, 2.9343e-02,
        1.1563e-03, 3.1053e-02, 5.3325e-02, 6.9534e-02, 2.9707e-02, 3.5810e-02,
        6.3766e-02, 5.7391e-02, 1.4376e-02, 3.6173e-02, 4.4379e-02, 1.8042e-02,
        7.5451e-02, 4.9030e-02, 5.4973e-02, 7.0294e-02, 3.0380e-02, 2.1730e-02,
        3.8111e-02, 3.1731e-01, 1.6849e-02, 1.1503e-02, 3.5284e-01, 4.1859e-03,
        1.7025e-01, 1.3824e-01, 6.4216e-02, 6.0989e-02, 4.6951e-03, 4.2172e-02,
        4.3387e-02, 5.7121e-02, 2.1796e-02, 4.5590e-02, 4.1056e-02, 4.4413e-02,
        2.6354e-02, 1.8029e-02, 1.7794e-02, 4.2572e-02, 1.6276e-02, 5.4140e-03,
        4.2075e-02, 2.6312e-02, 3.6692e-02, 4.0741e-02, 5.6725e-02, 1.6213e-02,
        8.1079e-02, 3.7600e-02, 1.9786e-02, 7.4669e-02, 5.0411e-02, 5.4657e-02,
        4.1381e-02, 6.4260e-02, 5.0551e-02, 7.0333e-02, 1.6034e-01, 1.7354e-01,
        1.0383e-01, 9.4621e-02, 1.2238e-01, 1.8241e-01, 4.0724e-02, 9.5311e-02,
        1.3003e-01, 1.3004e-01, 1.5595e-01, 1.1952e-01, 1.1608e-01, 1.3914e-01,
        1.6103e-01, 5.9625e-02, 2.0770e-01, 3.3645e-01, 1.1916e-01, 7.7401e-02,
        4.5272e-01, 1.8657e-01, 1.8825e-01, 1.7505e-01, 6.9466e-02, 1.3356e-01,
        2.0526e-01, 9.5517e-02])
    actual = np.array(extract_1d(jit_file(f"{MLIR_FILES}/lstm/lstm_model.mlir")))
    assert np.abs(actual - expected).sum() < 1e-4
